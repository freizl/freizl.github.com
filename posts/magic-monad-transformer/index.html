<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<style type=text/css>body{font-family:monospace}</style>
<title>Magic Monad Transformer</title>
<link rel=stylesheet href=../../css/style.css>
</head>
<body>
<header>
=================<br>
== <a href=https://freizl.github.io/>Corner case</a> ==<br>
=================
<div style=float:right>Welcome to my new blog!</div><br>
<p>
<nav>
<a href=../../><b>Start</b></a>.
</header>
<main>
<article>
<h1>Magic Monad Transformer</h1>
<b><time>04/07/2012</time></b>
<a href=../../tags/monad>monad</a>
<a href=../../tags/mtl>mtl</a>
<a href=../../tags/haskell>haskell</a>
<div>
<h2 id=monad-transformer>Monad-Transformer</h2>
<p>The code fragment below is from chapter 18 Monad Transform of <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p>
<p>When the first time I read this example, I was confused with how it is
possible to use <code>ask</code> of <code>MonadReader</code> (line 6) and <code>get</code> of
<code>MonadState</code> (line 13) functions in the same <code>App</code> Monad content.</p>
<p>The only reasonable explanation is that <code>App</code> is both <code>MonadReader</code> and
<code>MonadState</code>. While looking at <code>App</code> type definition (line 1), seems it
is not possible.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell>  <span style=color:#66d9ef>type</span> <span style=color:#66d9ef>App</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ReaderT</span> <span style=color:#66d9ef>AppConfig</span> (<span style=color:#66d9ef>StateT</span> <span style=color:#66d9ef>AppState</span> <span style=color:#66d9ef>IO</span>)

  constrainedCount <span style=color:#f92672>::</span> <span style=color:#66d9ef>Int</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>FilePath</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>App</span> [(<span style=color:#66d9ef>FilePath</span>, <span style=color:#66d9ef>Int</span>)]
  constrainedCount curDepth path <span style=color:#f92672>=</span> <span style=color:#66d9ef>do</span>
    contents <span style=color:#f92672>&lt;-</span> liftIO <span style=color:#f92672>.</span> listDirectory <span style=color:#f92672>$</span> path
    cfg <span style=color:#f92672>&lt;-</span> ask
    rest <span style=color:#f92672>&lt;-</span> forM contents <span style=color:#f92672>$</span> <span style=color:#a6e22e>\</span>name <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>do</span>
              <span style=color:#66d9ef>let</span> newPath <span style=color:#f92672>=</span> path <span style=color:#f92672>&lt;/&gt;</span> name
              isDir <span style=color:#f92672>&lt;-</span> liftIO <span style=color:#f92672>$</span> doesDirectoryExist newPath
              <span style=color:#66d9ef>if</span> isDir <span style=color:#f92672>&amp;&amp;</span> curDepth <span style=color:#f92672>&lt;</span> cfgMaxDepth cfg
                <span style=color:#66d9ef>then</span> <span style=color:#66d9ef>do</span>
                  <span style=color:#66d9ef>let</span> newDepth <span style=color:#f92672>=</span> curDepth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
                  st <span style=color:#f92672>&lt;-</span> get
                  when (stDeepestReached st <span style=color:#f92672>&lt;</span> newDepth) <span style=color:#f92672>$</span>
                    put st { stDeepestReached <span style=color:#f92672>=</span> newDepth }
                  constrainedCount newDepth newPath
                <span style=color:#66d9ef>else</span> return <span style=color:#66d9ef>[]</span>
    return <span style=color:#f92672>$</span> (path, length contents) <span style=color:#66d9ef>:</span> concat rest
</code></pre></div><h2 id=what-is-the-so-called-magic>What is the so-called &ldquo;Magic&rdquo;</h2>
<p>I turn to the source of package mtl<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> and finding following
implementations.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell>
  <span style=color:#75715e>-- | ReaderT</span>
  <span style=color:#66d9ef>instance</span> (<span style=color:#66d9ef>Monad</span> m) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>MonadReader</span> r (<span style=color:#66d9ef>ReaderT</span> r m) <span style=color:#66d9ef>where</span>
      ask <span style=color:#f92672>=</span> <span style=color:#66d9ef>ReaderT</span><span style=color:#f92672>.</span>ask
      local <span style=color:#f92672>=</span> <span style=color:#66d9ef>ReaderT</span><span style=color:#f92672>.</span>local

  <span style=color:#75715e>-- | StateT</span>
  <span style=color:#66d9ef>instance</span> (<span style=color:#66d9ef>Monad</span> m) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>MonadState</span> s (<span style=color:#66d9ef>Lazy</span><span style=color:#f92672>.</span><span style=color:#66d9ef>StateT</span> s m) <span style=color:#66d9ef>where</span>
      get <span style=color:#f92672>=</span> <span style=color:#66d9ef>Lazy</span><span style=color:#f92672>.</span>get
      put <span style=color:#f92672>=</span> <span style=color:#66d9ef>Lazy</span><span style=color:#f92672>.</span>put

  <span style=color:#75715e>-- | Combine ReaderT and StataT</span>
  <span style=color:#66d9ef>instance</span> (<span style=color:#66d9ef>MonadState</span> s m) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>MonadState</span> s (<span style=color:#66d9ef>ReaderT</span> r m) <span style=color:#66d9ef>where</span>
      get <span style=color:#f92672>=</span> lift get
      put <span style=color:#f92672>=</span> lift <span style=color:#f92672>.</span> put
</code></pre></div><p>If we do a substitution, will get</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell>  <span style=color:#66d9ef>instance</span> <span style=color:#66d9ef>MonadReader</span> <span style=color:#66d9ef>AppConfig</span> <span style=color:#66d9ef>App</span> <span style=color:#66d9ef>where</span> <span style=color:#f92672>...</span>

  <span style=color:#66d9ef>instance</span> (<span style=color:#66d9ef>MonadState</span> <span style=color:#66d9ef>AppState</span> (<span style=color:#66d9ef>StateT</span> <span style=color:#66d9ef>AppState</span> <span style=color:#66d9ef>IO</span>)
         <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>MonadState</span> <span style=color:#66d9ef>AppState</span> (<span style=color:#66d9ef>ReaderT</span> <span style=color:#66d9ef>AppConfig</span> (<span style=color:#66d9ef>StateT</span> <span style=color:#66d9ef>AppState</span> <span style=color:#66d9ef>IO</span>)) <span style=color:#66d9ef>where</span> <span style=color:#f92672>...</span>
     <span style=color:#f92672>~&gt;</span> <span style=color:#66d9ef>instance</span> <span style=color:#66d9ef>MonadState</span> <span style=color:#66d9ef>AppState</span> <span style=color:#66d9ef>App</span> <span style=color:#66d9ef>where</span> <span style=color:#f92672>...</span>
</code></pre></div><p>Therefore <code>App</code> is both MonadReader and MonadState.</p>
<h2 id=a-trivial-demo>A trivial demo</h2>
<p>I made a very trivial sampleÂ <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> demostrating combine ReaderT and
StateT.</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p><a href=http://book.realworldhaskell.org/read/monad-transformers.html>Chapter 8 Monad Transformer</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p><a href=http://hackage.haskell.org/package/mtl-2.0.1.0>mtl-2.0.1.0 in hackage</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p><a href=https://github.com/freizl/dive-into-haskell/blob/master/codes/monad/hello-mtl.hs>A clear demo</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
</article>
</main>
<aside>
<div>
<div>
<h3>LATEST POSTS</h3>
</div>
<div>
<ul>
<li><a href=../../posts/hello-hugo/>Hello Hugo</a></li>
<li><a href=../../posts/notes-sf-bay-area-must-do-hiking/>Notes Sf Bay Area Must Do Hiking</a></li>
<li><a href=../../posts/improve-space-usage/>Improve Space Usage</a></li>
<li><a href=../../posts/snaplet-request-local-state/>Snaplet Request Local State</a></li>
<li><a href=../../posts/chinese-tag-in-hakyll/>Chinese Tag In Hakyll</a></li>
</ul>
</div>
</div>
</aside>
<footer>
<p>&copy; 2021 <a href=https://freizl.github.io/><b>Haisheng Wu</b></a>.
</p>
</footer>
</body>
</html>